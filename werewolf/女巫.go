package werewolf

import (
	"encoding/json"
	"fmt"

	"github.com/google/uuid"
)

// Witch ç©å®¶
type Witch struct {
	*Human
	æœ‰æ¯’è—¥ bool
	æœ‰è§£è—¥ bool
}

// NewWitch å»ºç«‹æ–°å¥³å·«
func NewWitch(éŠæˆ² *Game, ä½å­ int) *Witch {
	human := NewHuman(éŠæˆ², ä½å­)
	return &Witch{
		Human: human,
		æœ‰æ¯’è—¥:   true,
		æœ‰è§£è—¥:   true,
	}
}

func (æˆ‘ *Witch) ç¨®æ—() GROUP {
	return ç¥è·
}

func (æˆ‘ *Witch) è·æ¥­() RULE {
	return å¥³å·«
}

func (æˆ‘ *Witch) èƒ½åŠ›(i int) (_ Player) {

	æœ‰ä½¿ç”¨éè—¥äº†å— := false

	if æˆ‘.æœ‰è§£è—¥ {
		æˆ‘.éŠæˆ².æ—ç™½(å‚³è¼¸è³‡æ–™{Sound: "ä»–è¢«æ®ºäº†ï¼Œä½ è¦æ•‘ä»–å—ï¼Ÿ"}, 1500)

		è¢«ç‹¼æ®ºç©å®¶ := æˆ‘.éŠæˆ².å°‹æ‰¾æ·˜æ±°è€…(ç‹¼æ®º)

		// å¥³å·«æ˜¯å¦æ•‘äºº
		if è¢«ç‹¼æ®ºç©å®¶ != nil && !æˆ‘.å‡ºå±€äº†() {

			å¯ä»¥æ•‘ := !(æˆ‘.éŠæˆ².è¼ªæ•¸ >= 2 && è¢«ç‹¼æ®ºç©å®¶.è™Ÿç¢¼() == æˆ‘.è™Ÿç¢¼())
			æ•‘çš„é¸é … := map[string]string{
				"ä¸æ•‘ğŸ˜µ": "no",
			}
			é¡¯ç¤ºæ–‡å­— := fmt.Sprintf("ä½ è¦æ•‘ã€%dè™Ÿç©å®¶ã€å—ï¼Ÿ", è¢«ç‹¼æ®ºç©å®¶.è™Ÿç¢¼())
			if å¯ä»¥æ•‘ {
				æ•‘çš„é¸é …["æ•‘ğŸ’Š"] = "yes"
			} else {
				é¡¯ç¤ºæ–‡å­— += "  (ä¸èƒ½æ•‘è‡ªå·±å”·å“ˆå“ˆå“ˆç¬¨è›‹)"
			}

			uid := newUID()
			æˆ‘.éŠæˆ².æ—ç™½æœ‰è©±å°å–®å€‹ç©å®¶èªª(æˆ‘, å‚³è¼¸è³‡æ–™{
				UID:     uid,
				Display: é¡¯ç¤ºæ–‡å­—,
				Action:  ç­‰å¾…å›æ‡‰,
				Data:    æ•‘çš„é¸é …,
			}, 0)

			æ˜¯å¦ä½¿ç”¨è§£è—¥, err := æˆ‘.ç­‰å¾…å‹•ä½œ(ç­‰å¾…å›æ‡‰, uid)

			if err != nil || æ˜¯å¦ä½¿ç”¨è§£è—¥.Reply == "yes" {
				æˆ‘.éŠæˆ².æ•‘ç©å®¶(ç‹¼æ®º)
				æˆ‘.æœ‰è§£è—¥ = false
				æœ‰ä½¿ç”¨éè—¥äº†å— = true
			}
		} else {
			æˆ‘.éŠæˆ².ç­‰ä¸€ä¸‹(random(3) * 2500)
		}
	}

	æˆ‘.éŠæˆ².æ—ç™½(å‚³è¼¸è³‡æ–™{Sound: "ä½ è¦ä½¿ç”¨æ¯’è—¥å—ï¼Ÿä½ è¦æ¯’èª°å‘¢ï¼Ÿ"}, 1500)

	if !æœ‰ä½¿ç”¨éè—¥äº†å— && æˆ‘.æœ‰æ¯’è—¥ && !æˆ‘.å‡ºå±€äº†() {

		uid := uuid.New().String()
		æˆ‘.éŠæˆ².æ—ç™½æœ‰è©±å°å–®å€‹ç©å®¶èªª(æˆ‘, å‚³è¼¸è³‡æ–™{
			UID:     uid,
			Display: "ä½ è¦ä½¿ç”¨æ¯’è—¥å—ï¼Ÿ",
			Action:  ç­‰å¾…å›æ‡‰,
			Data: map[string]interface{}{
				"è¦ğŸ’‰":  "yes",
				"ä¸è¦ğŸ˜": "no",
			},
		}, 0)

		//å¦‚æœæ˜¯ç¬¬äºŒæ™šä¹‹å¾Œè¢«æ®ºçš„æ˜¯å¥³å·«ï¼Œå‰‡ä¸èƒ½ä½¿ç”¨è§£è—¥
		æ˜¯å¦ä½¿ç”¨æ¯’è—¥, err := æˆ‘.ç­‰å¾…å‹•ä½œ(ç­‰å¾…å›æ‡‰, uid)
		if err != nil {
			return
		}

		if æ˜¯å¦ä½¿ç”¨æ¯’è—¥.Reply == "yes" {

			æˆ‘.æœ‰æ¯’è—¥ = false
			å¯æ¯’çš„ç©å®¶è™Ÿç¢¼ := []int{}
			ç›®å‰å­˜æ´»ç©å®¶å€‘ := æˆ‘.éŠæˆ².å­˜æ´»ç©å®¶å€‘()

			for i := range ç›®å‰å­˜æ´»ç©å®¶å€‘ {
				ç©å®¶ := ç›®å‰å­˜æ´»ç©å®¶å€‘[i]
				if æˆ‘.è™Ÿç¢¼() == ç©å®¶.è™Ÿç¢¼() {
					continue
				}
				å¯æ¯’çš„ç©å®¶è™Ÿç¢¼ = append(å¯æ¯’çš„ç©å®¶è™Ÿç¢¼, ç©å®¶.è™Ÿç¢¼())
			}

			uid := uuid.New().String()
			æˆ‘.éŠæˆ².æ—ç™½æœ‰è©±å°å–®å€‹ç©å®¶èªª(æˆ‘, å‚³è¼¸è³‡æ–™{
				UID:     uid,
				Display: "ä½ è¦æ¯’èª°å‘¢ï¼Ÿ",
				Action:  é¸æ“‡ç©å®¶,
				Data:    å¯æ¯’çš„ç©å®¶è™Ÿç¢¼,
			}, 0)

			for {
				è¢«å¥³å·«æ¯’çš„äºº, err := æˆ‘.ç­‰å¾…å‹•ä½œ(é¸æ“‡ç©å®¶, uid)
				if err != nil {
					return
				}

				ç©å®¶è™Ÿç¢¼ := 0
				err = json.Unmarshal([]byte(è¢«å¥³å·«æ¯’çš„äºº.Reply), &ç©å®¶è™Ÿç¢¼)
				if err != nil {
					continue
				}

				ç©å®¶, å­˜åœ¨ := æˆ‘.éŠæˆ².ç©å®¶è³‡æ–™(ç©å®¶è™Ÿç¢¼)
				if å­˜åœ¨ {
					æˆ‘.éŠæˆ².æ®ºç©å®¶(æ¯’æ®º, ç©å®¶)
					return
				}
			}
		}
	} else {
		æˆ‘.éŠæˆ².ç­‰ä¸€ä¸‹(random(3) * 2500)
	}

	return
}

func (æˆ‘ *Witch) éœ€è¦å¤œæ™šè¡Œå‹•() bool {
	return true
}
