<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Â∞èÂ∞èÁãº‰∫∫ÊÆ∫</title>

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>

<body>
    <div id="app" class="container">
        <div class="fixed-action-btn">
            <a class="btn-floating btn-large teal">
                <i class="large material-icons">translate</i>
            </a>
            <ul>
                <li v-for="v in voices">
                    <a v-if="v.lang === voice.lang" class="btn-floating purple lighten-2 btn-large">{{ v.text }}</a>
                    <a v-else class="btn-floating teal lighten-2 btn-large" @mousedown="changeLang(v)">{{ v.text }}</a>
                </li>
            </ul>
        </div>

        <div class="row">
            <div class="col s12">
                <h4>Ê≠°ËøéÁãº‰∫∫ÊÆ∫ ü§™</h4>
            </div>

            <div class="col s12">
                <!-- È°ØÁ§∫Ëº∏Âá∫ -->
                <div v-if="output !== ''">
                    <p>{{ output }}</p>
                </div>

                <div v-if="gameOver">
                    <button class="waves-effect waves-light btn" @mousedown="finishGame">
                        <i class="material-icons small">check</i>ÈÅäÊà≤ÁµêÊùü
                    </button>
                </div>

            </div>

            <div v-if="ws === null && !gameOver" class="input-field col s12">
                <input id="token" class="validate" type="text" v-model="token" :autofocus="this.token !== ''" />
                <label for="token">Ëº∏ÂÖ•Token...</label>

                <button class="waves-effect waves-light btn cyan darken-1" @mousedown="joinGame()">Âä†ÂÖ•ÈÅäÊà≤</button>
            </div>

            <div v-else class="col s12">
                <!-- È°ØÁ§∫sessionËº∏ÂÖ• -->
                <div v-if="needEnterSession" class="input-field">
                    <input id="session" class="validate" type="text" v-model="session" />
                    <label for="session">Ëº∏ÂÖ•ËôüÁ¢º...</label>

                    <button class="waves-effect waves-light btn cyan darken-1" @mousedown="joinGame()">Âä†ÂÖ•ÈÅäÊà≤</button>
                </div>

                <!-- È°ØÁ§∫ËßíËâ≤Ë®≠ÂÆö -->
                <div v-if="showRules">
                    <label for="combine">
                        <input type="radio" id="combine" value="combine" v-model="setRuleType">
                        <span>Âø´ÈÄüÁµÑÂêà</span>
                    </label>

                    <label for="rule">
                        <input type="radio" id="rule" value="rule" v-model="setRuleType">
                        <span>Ëá™Ë®ÇËßíËâ≤</span>
                    </label>

                    <div v-if="setRuleType === 'combine'">
                        <hr />
                        <label v-for="n in combine">
                            <input name="combine-value" type="radio" :value="n" v-model="selectedRule" />
                            <span>{{ n }}</span>
                        </label>
                    </div>
                    <div v-else>
                        <label v-for="c,r in rules">
                            <span>{{ r }}</span>
                            <input :id="r" type="number" min="0" @change="changeRule" @keyup="changeRule" />
                        </label>
                    </div>

                    <br />

                    <button class="waves-effect waves-light btn-small" @mousedown="sendGame()">setup</button>
                </div>

                <!-- È°ØÁ§∫ÈÅ∏ÊìáËôüÁ¢º -->
                <div v-if="showNumber">
                    <hr>

                    <div class="row">
                        <div v-for="n in numbers" :class="'col s' + parseInt(12 / numbers.length)">
                            <a class="btn-floating btn pulse" @mousedown="selectNumber(n)">{{ n }}</a>
                        </div>
                    </div>
                </div>


                <!-- Á≠âÂæÖÁ¢∫Ë™ç -->
                <div v-if="isWaiting" class="row">
                    <div v-for="v,k in waitingOptions" :class="'col s' + optionsCol">
                        <a class="btn-floating btn pulse" @mousedown="selectOptions(k, v)">{{ k }}</a>
                    </div>
                </div>

                <!-- È°ØÁ§∫ÁµêÊûú -->
                <div v-if="showVote">
                    <hr />
                    <ul class="collection">
                        <li v-for="v,k in voteResult" class="collection-item">
                            {{ k }} <i class="material-icons small">restaurant_menu</i> {{ v }}
                        </li>
                    </ul>
                </div>

                <!-- Êàø‰∏ªÊåâÈàï -->
                <div v-if="leader && !gameStart">
                    <button class="waves-effect waves-light btn" @mousedown="sendGame">
                        <i class="material-icons">send</i>ÈÅäÊà≤ÈñãÂßã
                    </button>
                </div>

                <!-- È°ØÁ§∫Áé©ÂÆ∂Ë≥áË®ä -->
                <div v-if="no !== ''">
                    <hr />
                    <ul class="collection">
                        <li class="collection-item">
                            <i class="material-icons small deep-purple-text text-darken-2">casino</i> ËôüÁ¢º
                            <span class="deep-purple-text text-darken-2">#{{ no }}</span>
                        </li>
                        <li class="collection-item">
                            <i class="material-icons small teal-text text-darken-2">account_box</i> ËßíËâ≤
                            <span class="teal-text text-darken-2">#{{ player }}</span>
                        </li>
                        <li class="collection-item">
                            <i class="material-icons small red-text text-darken-3">airline_seat_flat</i> Â≠òÊ¥ª
                            <i v-if="isOut"
                                class="material-icons small red-text text-lighten-2">cancel</i>
                            <i v-else
                                class="material-icons small light-green-text text-lighten-2">check_circle</i>
                        </li>
                        <li class="collection-item">
                            <i class="material-icons small light-blue-text text-darken-4">person_add</i> Êàø‰∏ª
                            <i v-if="leader"
                                class="material-icons small light-green-text text-lighten-2">check_circle</i>
                            <i v-else class="material-icons small red-text text-lighten-2">cancel</i>
                        </li>
                        <li class="collection-item">
                            <i class="material-icons small orange-text text-darken-2">fingerprint</i> Token:
                            <span class="orange-text text-darken-2">{{ token }}</span>
                        </li>
                        <li class="collection-item">
                            <i class="material-icons small brown-text text-darken-4">people</i> ‰∫∫Êï∏
                            <span v-for="on in online">
                                <i v-if="on" class="material-icons small brown-text text-darken-4">person</i>
                                <i v-else class="material-icons small brown-text text-darken-4">person_outline</i>
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                synth: null,
                voices: [],
                voice: null,
                token: '',
                session: '',
                input: '',
                action: '',
                output: '',
                list: '',
                no: '',
                player: '',
                leader: false,
                ws: null,
                showNumber: false,
                numbers: [],
                selectedNumber: 0,
                showRules: false,
                combine: [],
                rules: {},
                selectedRule: '',
                setRuleType: 'combine',
                gameStart: false,
                gameOver: false,
                needEnterSession: false,
                isWaiting: false,
                waitingOptions: {},
                showVote: false,
                voteResult: {},
                isOut: false,
                online: [],
            },
            methods: {
                joinGame() {

                    if (this.ws !== null) {
                        if (this.needEnterSession) {
                            this.input = this.session
                            this.sendGame()
                            return
                        }

                        return
                    }

                    const ws = new WebSocket(this.wsURL + '?token=' + this.token)
                    this.ws = ws
                    ws.onmessage = this.receiveGame
                    ws.onclose = this.closedGame
                },
                closedGame() {
                    this.ws = null
                    this.resetInfo()
                    this.showVote = false
                    if (this.gameStart) {
                        this.output = 'ÈÅäÊà≤Â∑≤Á∂ìÈóúÈñâ'
                    }
                },
                sendGame() {
                    this.ws.send(JSON.stringify({
                        'action': this.action,
                        'reply': `${this.input}`,
                    }))
                },
                changeRule(e) {
                    const rule = e.target.id
                    const n = parseInt(e.target.value)
                    if (n === 0 || n === null) {
                        this.selectedRule[rule] = 0
                    } else {
                        this.selectedRule[rule] = n
                    }
                    this.input = JSON.stringify(this.selectedRule)
                    console.log('rule', this.input)
                },
                selectNumber(n) {
                    if (this.selectedNumber !== 0) {
                        return
                    }

                    this.selectedNumber = n
                    this.numbers = [this.selectedNumber]
                    this.input = n + ''
                    this.sendGame()
                },
                selectOptions(k, v) {
                    this.waitingOptions = {}
                    this.waitingOptions[k] = v
                    this.input = v
                    this.sendGame()
                },
                resetInfo() {
                    this.leader = false
                    this.no = ''
                    this.player = ''
                    this.session = ''
                },
                finishGame() {
                    this.gameOver = false
                    this.output = ''
                    this.sendGame()
                },
                changeLang(v) {
                    this.voice = v.voice
                    M.Toast.dismissAll();
                    setTimeout(() => {
                        M.toast({ html: `ÊîπÊàê ${v.voice.name} ÁôºÈü≥` })
                    }, 1)
                },
                speak(sound) {
                    if (this.voice === null) {
                        return
                    }
                    const speech = new window.SpeechSynthesisUtterance(sound)
                    speech.voice = this.voice
                    window.speechSynthesis.speak(speech)
                },
                receiveGame(e) {
                    if (e.data === 'ping') {
                        return
                    }

                    const tmp = JSON.parse(e.data)

                    if (tmp.action === 'refresh_online') {
                        this.online = tmp.data
                        return
                    }

                    if (tmp.action === 'change_room_master') {
                        this.leader = true
                        this.gameStart = tmp.data['ÈÅäÊà≤ÈñãÂßã']
                        if (!this.gameStart) {
                            this.action = 'change_room_master'
                            this.input = 'start'
                        }
                        return
                    }


                    this.output = tmp.sound
                    if (tmp.display !== '') {
                        this.output = tmp.display
                    }

                    this.speak(tmp.sound)

                    this.showRules = false
                    this.showNumber = false
                    this.needEnterSession = false
                    this.isWaiting = false
                    this.waitingOptions = { 'Á¢∫Ë™ç': '' }
                    this.hasSkill = false
                    this.action = tmp.action

                    switch (tmp.action) {
                        case 'role_setup':
                            this.resetInfo()
                            // ËßíËâ≤Ë®≠ÂÆö
                            this.showRules = true
                            this.combine = tmp.data.combine
                            if (this.combine.length > 0) {
                                this.setRuleType = 'combine'
                                this.selectedRule = this.combine[0]
                                this.input = this.selectedRule
                            } else {
                                this.setRuleType = 'rule'
                                this.input = {}
                            }
                            this.rules = tmp.data.rule
                            this.gameOver = false
                            break
                        case 'select_number':
                            this.resetInfo()
                            // ÈÅ∏ÊìáËôüÁ¢º
                            this.selectedNumber = 0
                            this.showNumber = true
                            this.numbers = tmp.data
                            break
                        case 'take_rule':
                            this.session = tmp.data['Á∑®Ëôü']
                            this.no = tmp.data['‰ΩçÂ≠ê']
                            this.player = tmp.data['ËÅ∑Ê•≠']
                            this.output = 'Á≠âÂæÖÈÅäÊà≤ÈñãÂßã...'
                            break
                        case 'select_player':
                            // ÈÅ∏ÊìáËôüÁ¢º
                            this.selectedNumber = 0
                            this.showNumber = true
                            this.numbers = tmp.data
                            break
                        case 'game_is_running':
                            this.gameStart = true
                            this.needEnterSession = true
                            break
                        case 'all_close_eyes':
                            this.gameStart = true
                            break
                        case 'waiting':
                            this.isWaiting = true
                            if (tmp.data !== null && Object.keys(tmp.data).length > 0) {
                                this.waitingOptions = {}
                                for (const key in tmp.data) {
                                    this.waitingOptions[key] = tmp.data[key]
                                }
                            }
                            break
                        case 'take_token':
                            this.isWaiting = true
                            this.token = tmp.data
                            break
                        case 'game_over':
                            this.output = tmp.data
                            this.gameStart = false
                            this.gameOver = true
                            this.isOut = false
                            this.showVote = false
                            this.voteResult = {}
                            this.resetInfo()
                            break
                        case 'vote_result':
                            this.showVote = true
                            this.voteResult = tmp.data
                            break
                        case 'player_out':
                            this.isOut = true
                            break
                        default:
                            break
                    }
                }
            },
            watch: {
                setRuleType(v) {
                    if (v === 'combine') {
                        if (this.combine.length > 0) {
                            this.selectedRule = this.combine[0]
                        } else {
                            this.selectedRule = ''
                        }
                    } else {
                        this.selectedRule = {}
                    }
                },
                selectedRule(v) {
                    if (this.setRuleType == 'combine') {
                        this.input = v
                    }
                }
            },
            computed: {
                optionsCol() {
                    const optionLen = parseInt(12 / Object.keys(this.waitingOptions).length)
                    return optionLen > 12 ? 1 : optionLen
                },
                wsURL() {
                    let url = window.location.host + '/wf/game'
                    if (window.location.protocol === 'http:') {
                        url = 'ws://' + url
                    } else {
                        url = 'wss://' + url
                    }
                    return url
                }
            },
            mounted() {
                console.log('Ws URL', this.wsURL)
                if ('speechSynthesis' in window) {
                    this.synth = window.speechSynthesis
                    console.log('synth => ', this.synth)
                    setTimeout(() => {
                        let voices = this.synth.getVoices()
                        voices = voices.
                            filter((e) => e.lang.indexOf('zh-') > -1 || e.lang === 'en-US').
                            map((e) => {
                                let words = e.name.split(' ')
                                let text = words[words.length - 1]
                                if (words.length == 1) {
                                    words = e.name.split('¬†')
                                    text = words[words.length - 1]
                                    words = text.split('Ôºà')
                                    text = words[0]
                                }
                                if (e.lang === 'zh-TW') {
                                    this.voice = e
                                }
                                return {
                                    text: text,
                                    lang: e.lang,
                                    voice: e,
                                }
                            })

                        this.voices = {}
                        for (const i in voices) {
                            const voice = voices[i]
                            this.voices[voice.lang] = voice
                        }

                        console.log('this.voice => ', this.voice)
                        console.log('this.voices => ', this.voices)

                        setTimeout(() => {
                            const elems = document.querySelectorAll('.fixed-action-btn');
                            let instance = M.FloatingActionButton.init(elems, {
                                hoverEnabled: false,
                            });
                            console.log('this.voice => ', this.voice)
                            console.log('this.voices => ', this.voices)
                        }, 500)
                    }, 500)
                }
            }
        })
    </script>
</body>

</html>
