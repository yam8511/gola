<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>å°å°ç‹¼äººæ®º</title>

    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>

<body>
    <div id="app" class="container">
        <div class="row">
            <div class="col s12">
                <h4>æ­¡è¿ç‹¼äººæ®º ğŸ¤ª</h4>
            </div>

            <div class="col s12">
                <!-- é¡¯ç¤ºè¼¸å‡º -->
                <div v-if="output !== ''">
                    <p>{{ output }}</p>
                </div>

                <div v-if="gameOver">
                    <button class="waves-effect waves-light btn" @click="finishGame">
                        <i class="material-icons check"></i>éŠæˆ²çµæŸ
                    </button>
                </div>

            </div>

            <div v-if="ws === null && !gameOver" class="input-field col s12">
                <input id="token" class="validate" type="text" v-model="token" />
                <label for="token">è¼¸å…¥Token...</label>

                <button class="waves-effect waves-light btn cyan darken-1" @click="joinGame()">åŠ å…¥éŠæˆ²</button>
            </div>

            <div v-else class="col s12">
                <!-- é¡¯ç¤ºsessionè¼¸å…¥ -->
                <div v-if="needEnterSession" class="input-field">
                    <input id="session" class="validate" type="text" v-model="session" />
                    <label for="session">è¼¸å…¥Session...</label>

                    <button class="waves-effect waves-light btn cyan darken-1" @click="joinGame()">åŠ å…¥éŠæˆ²</button>
                </div>

                <!-- é¡¯ç¤ºè§’è‰²è¨­å®š -->
                <div v-if="showRules">
                    <label for="combine">
                        <input type="radio" id="combine" value="combine" v-model="setRuleType">
                        <span>å¿«é€Ÿçµ„åˆ</span>
                    </label>

                    <label for="rule">
                        <input type="radio" id="rule" value="rule" v-model="setRuleType">
                        <span>è‡ªè¨‚è§’è‰²</span>
                    </label>

                    <div v-if="setRuleType === 'combine'">
                        <hr />
                        <label v-for="n in combine">
                            <input name="combine-value" type="radio" :value="n" v-model="selectedRule" />
                            <span>{{ n }}</span>
                        </label>
                    </div>
                    <div v-else>
                        <label v-for="c,r in rules">
                            <span>{{ r }}</span>
                            <input :id="r" type="number" min="0" @change="changeRule" />
                        </label>
                    </div>

                    <br />

                    <button class="waves-effect waves-light btn-small" @click="sendGame()">setup</button>
                </div>

                <!-- é¡¯ç¤ºé¸æ“‡è™Ÿç¢¼ -->
                <div v-if="showNumber">
                    <hr>

                    <div class="row">
                        <div v-for="n in numbers" :class="'col s' + parseInt(12 / numbers.length)">
                            <a class="btn-floating btn pulse" @click="selectNumber(n)">{{ n }}</a>
                        </div>
                    </div>
                </div>


                <!-- ç­‰å¾…ç¢ºèª -->
                <div v-if="isWaiting">
                    <button  v-for="v,k in waitingOptions" class="waves-effect waves-light btn" @click="selectOptions(v)">
                        <i class="material-icons check"></i>{{ k }}
                    </button>
                </div>

                <!-- ç­‰å¾…æŠ€èƒ½ -->
                <div v-if="hasSkill">
                    <button class="waves-effect waves-light btn" @click="skill(0)">
                        <i class="material-icons close"></i>ä¸å•Ÿå‹•
                    </button>
                    <button class="waves-effect waves-light btn" @click="skill(1)">
                        <i class="material-icons check"></i>å•Ÿå‹•
                    </button>
                </div>

                <!-- æˆ¿ä¸»æŒ‰éˆ• -->
                <div v-if="leader && !gameStart">
                    <button class="waves-effect waves-light btn" @click="sendGame">
                        <i class="material-icons send"></i>éŠæˆ²é–‹å§‹
                    </button>
                </div>

                <!-- é¡¯ç¤ºç©å®¶è³‡è¨Š -->
                <div v-if="no !== ''">
                    <hr />
                    <div>{{ player }}</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                token: '',
                session: '',
                input: '',
                action: '',
                output: '',
                list: '',
                no: '',
                leader: false,
                ws: null,
                showNumber: false,
                numbers: [],
                selectedNumber: 0,
                showRules: false,
                combine: [],
                rules: {},
                selectedRule: '',
                setRuleType: 'combine',
                gameStart: false,
                gameOver: false,
                needEnterSession: false,
                isWaiting: false,
                waitingOptions: {},
                hasSkill: false,
                skillOption: '',
            },
            methods: {
                joinGame() {

                    if (this.ws !== null) {
                        if (this.needEnterSession) {
                            this.input = this.session
                            this.sendGame()
                            return
                        }

                        return
                    }

                    const ws = new WebSocket(this.wsURL + '?token=' + this.token)
                    this.ws = ws
                    ws.onmessage = this.receiveGame
                    ws.onclose = this.closedGame
                },
                closedGame() {
                    this.ws = null
                    if (this.gameStart) {
                        this.output = 'éŠæˆ²å·²ç¶“é—œé–‰'
                    }
                },
                sendGame() {
                    this.ws.send(JSON.stringify({
                        'action': this.action,
                        'reply': `${this.input}`,
                    }))
                },
                changeRule(e) {
                    const rule = e.target.id
                    const n = parseInt(e.target.value)
                    console.log(`${rule} x ${n}`)
                    if (n === 0) {
                        this.selectedRule[rule] = undefined
                    } else {
                        this.selectedRule[rule] = n
                    }
                    this.input = JSON.stringify(this.selectedRule)
                },
                selectNumber(n) {
                    if (this.selectedNumber !== 0) {
                        return
                    }

                    this.selectedNumber = n
                    this.numbers = [this.selectedNumber]
                    this.input = n + ''
                    this.sendGame()
                },
                skill(v) {
                    if (v == 1) {
                        this.input = this.skillOption
                    } else {
                        this.input = ''
                    }
                    this.sendGame()
                },
                selectOptions(v) {
                    this.input = v
                    this.sendGame()
                },
                resetInfo() {
                    this.leader = false
                    this.no = ''
                    this.session = ''
                },
                finishGame() {
                    this.gameOver = false
                    this.output = ''
                },
                receiveGame(e) {
                    const tmp = JSON.parse(e.data)
                    this.output = tmp.sound
                    if (tmp.display !== '') {
                        this.output = tmp.display
                    }

                    const speech = new window.SpeechSynthesisUtterance()
                    speech.text = tmp.sound
                    window.speechSynthesis.speak(speech)

                    this.showRules = false
                    this.showNumber = false
                    this.needEnterSession = false
                    this.isWaiting = false
                    this.waitingOptions = {'ç¢ºèª':''}
                    this.hasSkill = false
                    this.action = tmp.action

                    switch (tmp.action) {
                        case 'role_setup':
                            this.resetInfo()
                            // è§’è‰²è¨­å®š
                            this.showRules = true
                            this.combine = tmp.data.combine
                            if (this.combine.length > 0) {
                                this.setRuleType = 'combine'
                                this.selectedRule = this.combine[0]
                                this.input = this.selectedRule
                            } else {
                                this.setRuleType = 'rule'
                                this.input = {}
                            }
                            this.rules = tmp.data.rule
                            this.gameOver = false
                            break
                        case 'select_number':
                            this.resetInfo()
                            // é¸æ“‡è™Ÿç¢¼
                            this.showNumber = true
                            this.numbers = tmp.data
                            break
                        case 'take_rule':
                            this.session = tmp.data['ç·¨è™Ÿ']
                            this.no = `${tmp.data['ä½å­']}è™Ÿ${tmp.data['è·æ¥­']}`
                            this.output = 'ç­‰å¾…éŠæˆ²é–‹å§‹...'
                            break
                        case 'change_room_master':
                            this.leader = true
                            this.gameStart = tmp.data['éŠæˆ²é–‹å§‹']
                            this.input = 'start'
                            break
                        case 'select_player':
                            // é¸æ“‡è™Ÿç¢¼
                            this.selectedNumber = 0
                            this.showNumber = true
                            this.numbers = tmp.data
                            break
                        case 'game_is_running':
                            this.output = 'éŠæˆ²å·²ç¶“é–‹å§‹ï¼Œæƒ³é‡æ–°é€²å…¥éŠæˆ²ï¼Œè«‹è¼¸å…¥session'
                            this.gameStart = true
                            this.needEnterSession = true
                            break
                        case 'all_close_eyes':
                            this.gameStart = true
                            break
                        case 'waiting':
                            this.isWaiting = true
                            if (tmp.data!==null && Object.keys(tmp.data).length > 0) {
                                this.waitingOptions = {}
                                for (const key in tmp.data) {
                                    this.waitingOptions[key] = tmp.data[key]
                                }
                            }
                            break
                        case 'notify_skill':
                            this.hasSkill = true
                            this.skillOption = tmp.data
                            break
                        case 'game_over':
                            this.output = tmp.data
                            this.gameStart = false
                            this.gameOver = true
                            this.resetInfo()
                            break
                        default:
                            break
                    }
                }
            },
            watch: {
                setRuleType(v) {
                    if (v === 'combine') {
                        if (this.combine.length > 0) {
                            this.selectedRule = this.combine[0]
                        } else {
                            this.selectedRule = ''
                        }
                    } else {
                        this.selectedRule = {}
                    }
                },
                selectedRule(v) {
                    if (this.setRuleType == 'combine') {
                        this.input = v
                    }
                }
            },
            computed: {
                player() {
                    if (this.no === '') {
                        return ''
                    }

                    if (this.leader) {
                        return `æˆ‘æ˜¯${this.no}, ä¹Ÿæ˜¯æˆ¿ä¸», ç·¨è™Ÿ: ${this.session}`
                    }

                    return `æˆ‘æ˜¯${this.no}, ç·¨è™Ÿ: ${this.session}`
                },
                wsURL() {
                    let url = window.location.host + '/wf/game'
                    if (window.location.protocol === 'http:') {
                        url = 'ws://' + url
                    } else {
                        url = 'wss://' + url
                    }
                    return url
                }
            },
            mounted() {
                console.log('Ws URL', this.wsURL)
            }
        })
    </script>
</body>

</html>
