<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <title>æŸ¥è©¢å£ç½©æ•¸é‡èˆ‡åº—å®¶</title>
    <link id="favicon" rel="icon" href="favicon.png" type="image/png">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>

<body>
    <div id="app" class="container">
        <h4>å£ç½©åº—å®¶æ•¸é‡æŸ¥è©¢</h1>
        <qrcode :value="homeQRCode" :options="{ width: 200 }" /></qrcode>

        <div class="row">
            <div class="input-field inline col m10 s12">
                <input id="search" type="text" class="validate" v-model="search" @keyup.enter="searchMask" />
                <label for="search">æŸ¥è©¢åº—å®¶æˆ–åœ°å€æˆ–åœ°å€, ä¾‹å¦‚: ã€Œé³³å±±å€ é’å¹´è·¯ã€ æˆ– ã€Œä¸ä¸è—¥å±€ é«˜é›„ é³³å±±ã€</label>
            </div>
            <div class="input-field inline col m2 s12">
                <button class="btn waves-effect waves-light" type="submit" name="action" @click="searchMask">
                    æŸ¥è©¢
                    <i class="material-icons right">send</i>
                </button>
            </div>
        </div>
        <div v-if="loading" class="progress">
            <div class="indeterminate"></div>
        </div>
        <div v-if="data.length > 0" class="flow-text">
            <h5>ç›®å‰æœ‰<span class="red-text text-darken-2">{{ data.length }}</span>å®¶æœ‰å£ç½©ğŸ˜·ï¼Œé»æ“Šåº—å®¶æˆ–åœ°å€å¯æŸ¥çœ‹åœ°åœ–ğŸ—¾</h5>
            <ul class="collection">
                <li v-for="info in data" class="collection-item">
                    <p>æˆäººå£ç½©: {{ info.number }} | å°å­©å£ç½©: {{ info.child }}</p>
                    <p>ğŸ¥  <a class="blue-text text-darken-2" :href="info.name_url" target="_blank">{{ info.name }}<i class="small material-icons">open_in_new</i></a></p>
                    <p>ğŸ§­  <a class="teal-text text-darken-2" :href="info.address_url" target="_blank">{{ info.address }}<i class="small material-icons">open_in_new</i></a></p>
                    <p>ğŸ“  {{ info.phone }}  â± {{ info.updated_at }}</p>
                </li>
            </ul>
        </div>
        <div v-if="data.length > 3" class="row">
            <div v-if="loading" class="progress">
                <div class="indeterminate"></div>
            </div>
            <div class="input-field inline col m10 s12">
                <input id="search" type="text" class="validate" v-model="search" @keyup.enter="searchMask" />
                <label for="search">{{search}}</label>
            </div>
            <div class="input-field inline col m2 s12">
                <button class="btn waves-effect waves-light" type="submit" name="action" @click="searchMask">
                    æŸ¥è©¢
                    <i class="material-icons right">send</i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
    <script src="vue-qrcode.js"></script>
    <script>Vue.component(VueQrcode.name, VueQrcode);</script>
    <script>
        var vm = new Vue({
            el: '#app',
            data: {
                search: '',
                data: [],
                loading: false,
            },
            computed: {
                homeQRCode() {
                    return window.location.href
                },
            },
            methods: {
                alert(text) {
                    M.Toast.dismissAll();
                    M.toast({
                        html: text,
                        classes: 'rounded',
                    });
                },
                searchMask() {
                    this.search = this.search.trim()
                    localStorage.setItem('q', this.search)
                    if (this.search === '') {
                        return
                    }

                    this.loading = true
                    axios.get(`/api/mask?q=${this.search}`)
                        .then((response) => {
                            if (response.status !== 200 || response.data.error_code !== undefined) {
                                if (response.status !== 200) {
                                    this.alert(`ä¼ºæœå™¨ç›®å‰å£æ‰ä¸­... (Status: ${response.status})`)
                                } else {
                                    this.alert(`${response.data.error_text} (${response.data.error_code})`)
                                }
                                return
                            }

                            this.data = response.data
                        })
                        .catch((error) => {
                            console.log(`æŠ“å–å£ç½©APIæ™‚ï¼Œç™¼ç”Ÿæ„å¤–éŒ¯èª¤, ${error}`)
                            this.alert(`ç›®å‰ä¼ºæœå™¨æ²’æœ‰å•Ÿå‹•ï¼Œè«‹ç­‰å¾…ä¿®å¾©... (${error})`)
                        }).finally(() => {
                            this.loading = false
                        })
                }
            },
            mounted() {
                this.search = localStorage.getItem('q')
                this.searchMask()
            }
        })
    </script>
</body>

</html>
